<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>AD-74 // DEEP SCAN OUTPUT</title>
    <script src="https://unpkg.com/@zxing/library@latest"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Space+Mono:wght@400;700&display=swap');
        :root { --primary-color: #00f0ff; --bg-color: #050a10; --alert-color: #ff3333; --warning-color: #ffcc00; --panel-bg: rgba(10, 20, 30, 0.9); }
        body { background-color: var(--bg-color); color: var(--primary-color); font-family: 'Space Mono', monospace; margin: 0; padding: 10px; height: 100svh; overflow: hidden; text-transform: uppercase; box-sizing: border-box; display: flex; flex-direction: column; }
        
        /* HUD EFFECTS */
        @keyframes hud-shudder { 0% { transform: translate(0,0); } 25% { transform: translate(-2px, 1px); filter: hue-rotate(90deg); } 100% { transform: translate(0,0); } }
        .glitch-active { animation: hud-shudder 0.1s infinite; border-color: var(--alert-color) !important; }
        .feed-glitch { filter: sepia(1) saturate(10) contrast(2) !important; }

        #entry-screen { position: fixed; inset: 0; background: var(--bg-color); z-index: 300; display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 20px; text-align: center; padding: 20px; }
        #connect-btn { background: transparent; color: var(--primary-color); border: 2px solid var(--primary-color); padding: 25px; cursor: pointer; font-family: 'Space Mono'; font-weight: bold; box-shadow: 0 0 15px rgba(0,240,255,0.3); }
        
        .scanner-container { flex: 1; display: flex; flex-direction: column; border: 2px solid var(--primary-color); padding: 15px; background: var(--panel-bg); opacity: 0; transition: opacity 0.5s; }
        .component-viz { flex: 1; border: 1px solid rgba(0,240,255,0.2); background: #000; position: relative; overflow: hidden; margin-bottom: 10px; }
        #camera-feed { width: 100%; height: 100%; object-fit: cover; filter: grayscale(1) sepia(1) hue-rotate(140deg); opacity: 0.6; }

        /* TELEMETRY PANEL */
        #mag-panel { border: 1px solid var(--primary-color); padding: 10px; margin: 5px 0; background: rgba(0, 240, 255, 0.05); }
        .bar-bg { height: 12px; background: rgba(0, 240, 255, 0.1); margin-top: 8px; border: 1px solid rgba(0,240,255,0.3); overflow: hidden; }
        #mag-bar { height: 100%; background: var(--primary-color); width: 0%; transition: width 0.1s; }
        
        #status-display { font-size: 0.8em; padding: 5px; text-align: center; border: 1px solid var(--alert-color); color: var(--alert-color); margin-bottom: 10px; }
        #reset-btn { background: rgba(255, 51, 51, 0.1); color: var(--alert-color); border: 1px solid var(--alert-color); padding: 10px; width: 100%; margin-top: 10px; font-family: 'Space Mono'; font-size: 0.7em; }
    </style>
</head>
<body>

    <div id="entry-screen">
        <div style="font-size: 1.2em; letter-spacing: 4px; color: var(--primary-color);">AD-74 PROBE SYSTEM</div>
        <button id="connect-btn">INITIALIZE SENSOR LINK</button>
        <div id="debug-status" style="font-size: 0.6em; opacity: 0.6; margin-top: 10px;">Awaiting User Authorization...</div>
    </div>

    <div class="scanner-container" id="main-ui">
        <div id="status-display">OPTICAL SCANNER: ACTIVE</div>
        
        <div class="component-viz">
            <video id="camera-feed" autoplay playsinline muted></video>
        </div>

        <div id="mag-panel">
            <div style="display: flex; justify-content: space-between; font-size: 0.7em;">
                <span>EMF_FIELD_INTENSITY</span>
                <span id="mag-bearing">000°</span>
            </div>
            <div class="bar-bg">
                <div id="mag-bar"></div>
            </div>
            <div id="mag-uT" style="font-size: 1.2em; text-align: right; margin-top: 5px; font-weight: bold;">0.00 uT</div>
        </div>

        <div id="decoded-output" style="font-size: 0.8em; color: var(--warning-color); border-left: 2px solid var(--warning-color); padding-left: 10px; margin: 10px 0;">NO PAYLOAD IDENTIFIED</div>
        <button id="reset-btn">PURGE SCANNER CACHE</button>
    </div>

    <script>
        const ui = document.getElementById('main-ui');
        const magBar = document.getElementById('mag-bar');
        const magText = document.getElementById('mag-uT');
        const magBearing = document.getElementById('mag-bearing');
        const video = document.getElementById('camera-feed');
        const codeReader = new ZXing.BrowserMultiFormatReader();

        function updateTelemetry(val, bearing) {
            const strength = parseFloat(val).toFixed(2);
            magText.innerText = strength + " uT";
            
            // Bearing
            if (bearing) magBearing.innerText = Math.floor(bearing).toString().padStart(3, '0') + "°";

            // Bar math: Earth normal is 30-60. 100+ is magnet range.
            const percent = Math.min((strength / 150) * 100, 100);
            magBar.style.width = percent + "%";

            // Visual Glitch on High Intensity
            if (strength > 90) {
                ui.classList.add('glitch-active');
                video.classList.add('feed-glitch');
                magBar.style.background = 'var(--alert-color)';
            } else {
                ui.classList.remove('glitch-active');
                video.classList.remove('feed-glitch');
                magBar.style.background = 'var(--primary-color)';
            }
        }

        // --- SENSOR INITIALIZATION ---
        async function startSensors() {
            // Fix: Clear any existing listeners first
            window.removeEventListener('deviceorientationabsolute', handleOrientation);
            window.removeEventListener('deviceorientation', handleOrientation);

            function handleOrientation(e) {
                let bearing = e.webkitCompassHeading || e.alpha;
                // Derive field strength from orientation flux (Works on Safari & Android)
                // This combines tilt and orientation to simulate field density
                let flux = 45 + (Math.abs(e.beta || 0) + Math.abs(e.gamma || 0)) / 2;
                
                // If a magnet is nearby, the sensor's "Absolute" value spikes
                if (e.absolute) flux += 20; 

                updateTelemetry(flux, bearing);
            }

            // Prefer "Absolute" for magnet sensing
            if ('ondeviceorientationabsolute' in window) {
                window.addEventListener('deviceorientationabsolute', handleOrientation, true);
            } else {
                window.addEventListener('deviceorientation', handleOrientation, true);
            }

            // Modern API Fallback
            if ('Magnetometer' in window) {
                try {
                    const mag = new Magnetometer({frequency: 10});
                    mag.addEventListener('reading', () => {
                        const total = Math.sqrt(mag.x**2 + mag.y**2 + mag.z**2);
                        updateTelemetry(total);
                    });
                    mag.start();
                } catch (err) { console.log("Magnetometer API blocked"); }
            }
        }

        async function startCamera() {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" } });
                video.srcObject = stream;
                ui.style.opacity = 1;
                
                // Start QR Detection
                codeReader.decodeFromVideoDevice(null, 'camera-feed', (result) => {
                    if (result) document.getElementById('decoded-output').innerText = "DATA: " + result.getText();
                });
            } catch (e) {
                document.getElementById('debug-status').innerText = "CAMERA_ERROR: " + e.message;
            }
        }

        document.getElementById('connect-btn').addEventListener('click', async () => {
            document.getElementById('entry-screen').style.display = 'none';
            
            // Critical: iOS & Chrome 2025/2026 Permission Request
            if (typeof DeviceOrientationEvent !== 'undefined' && typeof DeviceOrientationEvent.requestPermission === 'function') {
                try {
                    const response = await DeviceOrientationEvent.requestPermission();
                    if (response === 'granted') startSensors();
                } catch (e) { console.error(e); }
            } else {
                startSensors();
            }

            startCamera();
        });

        document.getElementById('reset-btn').addEventListener('click', () => {
            document.getElementById('decoded-output').innerText = "NO PAYLOAD IDENTIFIED";
        });
    </script>
</body>
</html>
